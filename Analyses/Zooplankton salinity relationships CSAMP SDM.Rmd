---
title: "Zooplankton salinity relationships in Suisun"
author: "Sam Bashevkin"
date: "8/26/2022"
output: 
  html_document:
    toc: true
    toc_float: true
editor_options: 
  chunk_output_type: console
knit: (function(input, ...) {
    rmarkdown::render(
      input,
      output_dir = 'docs',
      envir = globalenv()
    )
    })
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(scipen=999)
```

# Load packages

```{r, message=FALSE, warning=FALSE}
require(dplyr)
require(zooper)
require(lubridate)
require(readr)
require(tidyr)
require(ggplot2)
require(sf)
require(readxl)
require(stringr)
require(mgcv)
require(purrr)
require(deltamapr)
require(scales)
```

# Load and wrangle data

```{r}
zoop_data<-Zoopsynther(Data_type="Community", Sources=c("EMP", "STN", "20mm", "FMWT"), Time_consistency = TRUE)
```


Read in zoop mass conversions
```{r}
zoop_mass_conversions<-read_excel("Data/SMSCG salinity modeling/Biomass conversions.xlsx", sheet="Micro and Meso-zooplankton")%>%
  mutate(Taxname=case_when(Taxname=="Sinocalanus"~"Sinocalanus doerrii", # Change to help this match to zoop data
                           TRUE ~ Taxname),
         Taxlifestage=paste(Taxname, Lifestage))%>%
  select(Taxlifestage, CarbonWeight_ug)
```

Read in zoop groupings
```{r}
zoop_groups<-read_csv("Data/zoopcrosswalk2.csv", col_types=cols_only(Taxlifestage="c", IBMR="c"))%>%
  distinct()
```


Load Mysid biomass data
```{r}
zoop_mysid<-read_excel("Data/1972-2020MysidBPUEMatrix.xlsx", # EMP
                       sheet="Mysid_BPUE_matrix_1972-2020", na = "NA",
                       col_types = c(rep("numeric", 4), "date", "text", "text", rep("text", 7), rep("numeric", 8)))%>%
  select(Date=SampleDate, Station=StationNZ, BPUE=`Hyperacanthomysis longirostris`)%>% # Only select Hyperacanthomysis longirostris
  mutate(Source="EMP")%>%
  bind_rows(read_csv("Data/FMWT STN 2007to2019 Mysid BPUE.csv", # FMWT/STN
                     col_types=cols_only(Station="c", SampleDate="c", Project="c", `Hyperacanthomysis longirostris`="d"))%>% 
              rename(Date=SampleDate, Source=Project, BPUE=`Hyperacanthomysis longirostris`)%>% # Only select Hyperacanthomysis longirostris
              mutate(Date=mdy(Date),
                     Station=recode(Station, MONT="Mont", HONK="Honk")))%>% #Get station names to match to main dataset
  mutate(BPUE_mysid=BPUE*1000, # Convert to ug
         Taxlifestage="Hyperacanthomysis longirostris Adult",
         SampleID=paste(Source, Station, Date),
         SizeClass="Macro")%>%
  select(SampleID, Taxlifestage, SizeClass, BPUE_mysid)
```


Start processing the zoop data
```{r}
zoop_data_mass<-zoop_data%>%
  mutate(Taxlifestage=str_remove(Taxlifestage, fixed("_UnID")))%>%
  filter(
    !(SizeClass=="Meso" & #eliminating species which are counted in meso and micro and retained better in the micro net from the meso calcs
        
        Taxlifestage%in%c("Asplanchna Adult", "Copepoda Larva","Cyclopoida Juvenile", "Eurytemora Larva", "Harpacticoida Undifferentiated",
                          "Keratella Adult", "Limnoithona Adult", "Limnoithona Juvenile", "Limnoithona sinenesis Adult", "Limnoithona tetraspina
                                    Adult", "Oithona Adult", "Oithona Juvenile", "Oithona davisae Adult", "Polyarthra Adult","Pseudodiaptomus Larva", 
                          "Rotifera Adult", "Sinocalanus doerrii Larva", "Synchaeta Adult", "Synchaeta bicornis Adult", "Trichocerca Adult")) &
      
      !(SizeClass=="Micro" &Taxlifestage%in%c("Cirripedia Larva", "Cyclopoida Adult", "Oithona similis")) & #removing categories better retained in meso net from micro net matrix
      Order!="Amphipoda" & # Remove amphipods
      (Order!="Mysida" | Taxlifestage=="Hyperacanthomysis longirostris Adult"))%>% #Only retain Hyperacanthomysis longirostris
  mutate(Taxlifestage=recode(Taxlifestage, `Synchaeta bicornis Adult`="Synchaeta Adult", # Change some names to match to biomass conversion dataset
                             `Pseudodiaptomus Adult`="Pseudodiaptomus forbesi Adult",
                             `Acanthocyclops vernalis Adult`="Acanthocyclops Adult"))%>%
  left_join(zoop_mass_conversions, by="Taxlifestage")%>% # Add biomass conversions
  left_join(zoop_mysid, by=c("SampleID", "Taxlifestage", "SizeClass"))%>% # Add mysid biomass
  left_join(zoop_groups, by="Taxlifestage")%>% # Add IBMR categories
  mutate(BPUE=if_else(Taxlifestage=="Hyperacanthomysis longirostris Adult", BPUE_mysid, CPUE*CarbonWeight_ug))%>% # Create 1 BPUE variable
  filter(!is.na(BPUE) & !is.na(Latitude) & !is.na(Longitude) & !is.na(SalSurf))%>% # Removes any data without BPUE, which is currently restricted to Decapod Larvae, and H. longirostris from STN. Also removes 20mm and EMP EZ stations without coordinates
  group_by(IBMR)%>%
  mutate(flag=if_else(all(c("Micro", "Meso")%in%SizeClass), "Remove", "Keep"))%>% # This and the next 2 lines are meant to ensure that all categories are consistent across the surveys. Since only EMP samples microzoops, only EMP data can be used for categories that include both micro and mesozoops.
  ungroup()%>%
  filter(!(flag=="Remove" & Source!="EMP"))%>%
  select(SampleID, Station, Latitude, Longitude, SalSurf, Date, Year, IBMR, BPUE)%>%
  group_by(across(-BPUE))%>%
  summarise(BPUE=sum(BPUE), .groups="drop")%>% # Sum each IBMR categories
  st_as_sf(coords=c("Longitude", "Latitude"), crs=4326)%>%
  st_transform(crs=st_crs(deltamapr::R_DSIBM)) %>% 
  st_join(deltamapr::R_DSIBM %>%
            select(SUBREGION)) %>%
  st_drop_geometry() %>% 
  filter(SUBREGION %in% c("NW Suisun","SW Suisun","NE Suisun","SE Suisun","Confluence", "Suisun Marsh"))%>%
  mutate(doy=yday(Date), #Day of year
         Year_fac=factor(Year), # Factor year for model random effect
         Station_fac=factor(Station), # Factor station for model random effect
         across(c(SalSurf, doy), list(s=~(.x-mean(.x))/sd(.x))), # Center and standardize predictors
         BPUE_log1p=log(BPUE+1)) # log1p transform BPUE for model


```

Check sample size
```{r message=FALSE, warning=FALSE}
zoop_sample_size <- zoop_data_mass %>% mutate(Month=month(Date)) %>%
  group_by(SampleID,Year,Month,SUBREGION,Station) %>% summarise(BPUE=sum(BPUE)) %>% mutate(Samplesize=1) %>%
  group_by(Year, Month, SUBREGION) %>% summarise(mean_BPUE=mean(BPUE),Samplesize=sum(Samplesize)) %>%
  filter(Year>=1995)

ggplot(zoop_sample_size, aes(x=Year, y=Month, fill=Samplesize))+
  geom_tile()+
  scale_y_continuous(breaks=1:12, labels=month(1:12, label=T))+
  scale_fill_viridis_c(breaks=c(1,5,10,15,20))+
  facet_wrap(~SUBREGION)+
  theme_bw()
```

All the remaining brackish regions have sufficient sample size with the exception of NE Suisun. As such, NE Suisun is to be combined with SE Suisun while the rest of the regions are to be analyzed on their own.

Create a new column with IBMR edited regions to accomodate combination of NE and SE Suisun regions.
```{r}
zoop_data_mass$Subregion_edit<-ifelse(zoop_data_mass$SUBREGION=="NE Suisun"|zoop_data_mass$SUBREGION=="SE Suisun","East Suisun",zoop_data_mass$SUBREGION)

```

# Model

## Prediction data

Set up prediction data for model
```{r}
# Min year to start models
year_min<-2000

newdata_function<-function(region, data=zoop_data_mass){
  
  data_filt<-data%>%
    filter(Subregion_edit%in%region & Year >= year_min)
  expand_grid(date=mdy(paste(1:12, 15, 2001, sep="/")), # The 15th of each month on a non-leap year
              SalSurf=seq(round(quantile(data_filt$SalSurf, 0.025), 1), 
                          round(quantile(data_filt$SalSurf, 0.975), 1), by=0.1))%>% # Salinity sequence nicely rounded to 1 decimal
    mutate(Month=month(date),
           doy=yday(date), # Day of year
           SalSurf_s=(SalSurf-mean(data$SalSurf))/sd(data$SalSurf), # center and standardize salinity to match data
           doy_s=(doy-mean(data$doy))/sd(data$doy))%>% # center and standardize doy to match data
    select(Month, doy, doy_s, SalSurf, SalSurf_s)
}

newdata<-map(set_names(unique(zoop_data_mass$Subregion_edit)), newdata_function)
```

## Model fitting

model
```{r}

sal_model<-function(group,region,new_data=newdata){
  
  cat("<<<<<<<<<<<<<<<<<<<<<<< modeling", group, region, ">>>>>>>>>>>>>>>>>>>>>>>>>\n\n")
  
  new_data<-new_data[[region]]
  
  data<-filter(zoop_data_mass, IBMR==group & Subregion_edit==region & Year>=year_min)
  
  par(mfrow=c(2,2))
  
  if(length(unique(data$Station_fac))>1){
  model<-gam(BPUE_log1p ~ te(SalSurf_s, doy_s, k=c(5,5), bs=c("cs", "cc")) + 
               s(Year_fac, bs="re") + s(Station_fac, bs="re"),
             data=data, 
             method="REML")
  
  random_effects<-c("s(Year_fac)", "s(Station_fac)")
    
  }else{
    
  model<-gam(BPUE_log1p ~ te(SalSurf_s, doy_s, k=c(5,5), bs=c("cs", "cc")) + 
               s(Year_fac, bs="re"),
             data=data, 
             method="REML")
  
  random_effects<-c("s(Year_fac)")
  }
  
  cat("-------------gam check-------------\n")
  gam.check(model)
  
  cat("\n\n-------------summary-------------\n")
  print(summary(model))
  
  sal<-predict(model, type="response", exclude=random_effects, newdata=new_data, se.fit=T, newdata.guaranteed=TRUE)%>%
    as_tibble()%>%
    mutate(across(everything(), as.vector))%>% # Make everything tidy
    rename(fit=starts_with("fit"), se=starts_with("se.fit"))%>%
    bind_cols(new_data%>% # Add covariate columns before these columns
                select(-doy_s, -SalSurf_s), 
              .)
  
  out<-list(model=model, sal=sal)
  return(out)
}
```

Apply model to all groups for the confluence region
```{r}
model_factors<-expand_grid(IBMR=unique(zoop_data_mass$IBMR),
                           Subregion_edit=unique(zoop_data_mass$Subregion_edit))%>%
  mutate(IBMR=set_names(IBMR, paste(IBMR, Subregion_edit)))

sal_models<-pmap(model_factors, function(IBMR, Subregion_edit) sal_model(IBMR, Subregion_edit))

```

## Extract salinity conversions 

```{r}
sal_conversions<-map_dfr(sal_models, ~.x[["sal"]], .id = "IBMR_region")%>%
  mutate(IBMR=sapply(IBMR_region, function(x) str_split(x, " ", n=2)[[1]][1]),
         Region=factor(sapply(IBMR_region, function(x) str_split(x, " ", n=2)[[1]][2]), levels=c("Confluence", "Suisun Marsh", "East Suisun", "NW Suisun", "SW Suisun")),
         Month=as.integer(Month))

str(sal_conversions)
```

plot salinity conversions
```{r, fig.width=12, fig.height=8}
ggplot(sal_conversions, aes(x=SalSurf, y=fit, ymin=fit-se, ymax=fit+se, fill=IBMR))+
  geom_ribbon(alpha=0.4)+
  ylab("fit (log scale)")+
  facet_grid(Region~Month)+
  scale_fill_viridis_d()+
  theme_bw()
```

# Apply model

Load in SMSCG modeled salinity
```{r, message=FALSE}
modeled_sal<-read_csv("Data/CSAMP_DS_SDM_salinity_scenarios.csv",
                    col_types = cols_only(region="c", year="i", month="i", 
                                           sal_base="d", sal_fallX2_hi="d", sal_fallX2_low="d", 
                                           sal_sumX2_hi="d", sal_sumX2_low ="d", sal_SMSCG="d"))%>%
  mutate(across(starts_with("sal_"), ~if_else(is.na(.x), sal_base, .x)))%>%
  filter(region%in%unique(zoop_data_mass$SUBREGION))%>%
  mutate(region=factor(region, levels=c("Confluence", "Suisun Marsh", "NE Suisun", "SE Suisun", "NW Suisun", "SW Suisun")))%>%
  pivot_longer(cols=starts_with("sal_"), names_to="Scenario", values_to="Salinity")%>% # Prepare data for easier plotting
         mutate(Scenario=factor(Scenario, 
                                levels=c("sal_base","sal_fallX2_hi","sal_fallX2_low","sal_sumX2_hi","sal_sumX2_low","sal_SMSCG")))%>%
  mutate(Salinity=round(Salinity, 1))
  
```

Plot SMSCG modeled salinity
```{r, fig.width=12, fig.height=8}
ggplot(modeled_sal, 
       aes(x=year, y=Salinity, color=Scenario))+
  geom_line()+
  scale_color_viridis_d()+
  facet_grid(region ~ month(month, label=T))+
  theme_bw()+
  theme(legend.position = "bottom", axis.text.x=element_text(angle=45, hjust=1))
```

salinity conversion function
```{r}
zoop_saladjusted<-modeled_sal%>%
  mutate(Salinity=as.character(Salinity),
         IBMR=unique(model_factors$IBMR)[1])%>%
  complete(region, year, month, Scenario, IBMR=unique(model_factors$IBMR))%>%
  group_by(region, year, month, Scenario)%>%
  mutate(Salinity=na.exclude(Salinity),
         region2=if_else(region%in%c("NE Suisun", "SE Suisun"), "East Suisun", as.character(region)))%>%
  left_join(sal_conversions%>%
              select(Region, Month, IBMR, SalSurf, fit)%>%
              mutate(SalSurf=as.character(SalSurf)),
            by=c("region2"="Region",
                 "month"="Month",
                 "Salinity"="SalSurf",
                 "IBMR"="IBMR"))%>%
  select(-Salinity, -region2)%>%
  mutate(fit=exp(fit)-1)%>%
  pivot_wider(names_from="Scenario", values_from="fit")%>%
  mutate(across(starts_with("sal_"), ~(.x-sal_base)/sal_base))
```

Plot the missing model results resulting from out-of-range salinity values in the inputs
```{r, fig.width=12, fig.height=8}
ggplot(zoop_saladjusted%>%
         filter(IBMR=="acartela")%>%
         pivot_longer(cols=starts_with("sal_"), names_to="Scenario", values_to="zoop_change"),
       aes(x=year, y=Scenario, fill=is.na(zoop_change)))+
  geom_tile()+
  scale_fill_viridis_d(name="Are the model results missing due to out-of-range salinity values?")+
  facet_grid(region ~ month(month, label=T))+
  theme_bw()+
  theme(legend.position = "bottom", axis.text.x=element_text(angle=45, hjust=1))
```

Plot the result

Create some plotting functions
```{r plot funcs}
neglop1p<-trans_new("neglop1p", transform=function(x) sign(x)*log(abs(x)+1), inverse=function(x) sign(x)*(exp(abs(x))-1))
plot_scenario_result <- function(scenario) {
ggplot(zoop_saladjusted,
       aes(x=year, y=.data[[scenario]], color=IBMR))+
  geom_point()+
  scale_color_viridis_d()+
  scale_y_continuous(trans=neglop1p, breaks=c(-1000, -100, -10, -1, 0, 1, 10, 100, 1000))+
  ylab("Proportional change in zooplankton biomass (log scale)")+
  facet_grid(region ~ month(month, label=T))+
  theme_bw()+
  theme(legend.position = "bottom", axis.text.x=element_text(angle=45, hjust=1))
}
```

```{r create plots}
# Create plots for each Parameter
scenario_result_plots <- tibble(Scenario=unique(modeled_sal$Scenario)[-1])%>%
  mutate(plot=map(as.character(unique(modeled_sal$Scenario))[-1], plot_scenario_result))
```

## Result plots {.tabset .tabset-pills}

```{r print plots, echo = FALSE, results = "asis", fig.width = 8, fig.height = 7}
for (i in 1:nrow(scenario_result_plots)) {
  # Create subheadings for each Parameter
  cat("### ", as.character(scenario_result_plots$Scenario[i]), "\n\n")
  # Print plot
  print(scenario_result_plots$plot[[i]])
  cat("\n\n")
}
```

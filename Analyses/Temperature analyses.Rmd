---
title: "Temperature analyses"
output: html_document
editor_options: 
  chunk_output_type: console
knit: (function(input, ...) {
    rmarkdown::render(
      input,
      output_dir = 'docs',
      knit_root_dir = "../",
      envir = globalenv()
    )
    })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages, message=FALSE, warning=FALSE}
require(dplyr)
require(DroughtData)
require(ggplot2)
require(patchwork)
require(knitr)
require(car)
require(multcomp)
require(emmeans)
require(stringr)
```

# Functions

```{r}
model_plotter<-function(model, data){
  data<-data%>%
    mutate(Residuals=resid(model),
           Fitted=predict(model))
  
  p_hist<-ggplot(data, aes(x=Residuals))+
    geom_histogram()+
    xlab("Residuals (°C)")+
    theme_bw()
  
  p_res_fit<-ggplot(data, aes(x=Residuals, y=Fitted))+
    geom_point()+
    ylab("Predicted temperature (°C)")+
    xlab("Residuals (°C)")+
    theme_bw()
  
  p_obs_fit<-ggplot(data, aes(x=Temperature, y=Fitted))+
    geom_point()+
    geom_abline(slope=1, intercept=0, color="red")+
    ylab("Predicted temperature (°C)")+
    xlab("Observed temperature (°C)")+
    theme_bw()
  
  out<-(p_hist+plot_layout(ncol=1))+(p_res_fit+p_obs_fit+plot_layout(ncol=2))+plot_layout(nrow=2, widths=c(1, 0.5, 0.5))
  
  return(out)
}

tukey_plotter<-function(model, data_type, model_type){
  
  tuk<-emmeans(model, list(data=data_type, model=model_type))
  
  tuk_data<-as_tibble(cld(tuk$data, sort=FALSE, Letters = letters))%>%
    mutate(.group=str_remove_all(.group, fixed(" ")))
  
  tuk_model<-as_tibble(cld(tuk$model, sort=FALSE, Letters = letters))%>%
    mutate(.group=str_remove_all(.group, fixed(" ")))
  
  p_data<-ggplot(tuk_data, aes(x=.data[[data_type]], y=emmean, ymin=lower.CL, ymax=upper.CL, label=.group))+
    geom_pointrange()+
    geom_text(aes(y=upper.CL+(max(upper.CL)-min(lower.CL))/20), size=6)+
    ylab("Temperature (°C)")+
    theme_bw(base_size=16)
  
  p_model<-ggplot(tuk_model, aes(x=.data[[model_type]], y=emmean, ymin=lower.CL, ymax=upper.CL, label=.group))+
    geom_pointrange()+
    geom_text(aes(y=upper.CL+(max(upper.CL)-min(lower.CL))/20), angle=if_else(model_type=="Year_fac", 90, 0), hjust=if_else(model_type=="Year_fac", "left", NA_character_), vjust=0.25, size=6)+
    ylab("Temperature (°C)")+
    theme_bw(base_size=16)
  
  if(model_type=="Year_fac"){
    p_model<-p_model+theme(axis.text.x=element_text(angle=90, vjust=0.5))
  }
  
  out<-p_data/p_model
  
  return(out)
}
```

# Load data

```{r}
data_regional<-lt_regional%>%
  filter(!is.na(Temperature))%>%
  mutate(Region=factor(Region, levels=c("Suisun Marsh", "Suisun Bay", "Confluence", "SouthCentral", "North")),
         Year_fac=factor(YearAdj),
         Drought=factor(Drought, levels=c("D", "N", "W")))
data_seasonal<-lt_seasonal%>%
  filter(!is.na(Temperature))%>%
  mutate(Season=factor(Season, levels=c("Winter", "Spring", "Summer", "Fall")),
         Year_fac=factor(YearAdj),
         Drought=factor(Drought, levels=c("D", "N", "W")))
```

# Plots

## Regional

Plot regional data by year

```{r}
ggplot(data_regional, aes(x=YearAdj, y=Temperature, fill=Drought))+
  geom_point(shape=21, color="black")+
  facet_wrap(~Region)+
  scale_fill_viridis_d()+
  ylab("Temperature (°C)")+
  theme_bw()
```

Plot regional data by Drought index

```{r}
ggplot(data_regional, aes(x=Drought, y=Temperature, fill=Drought))+
  geom_boxplot()+
  facet_wrap(~Region)+
  scale_fill_viridis_d()+
  ylab("Temperature (°C)")+
  theme_bw()
```

## Seasonal

Plot seasonal data by year

```{r}
ggplot(data_seasonal, aes(x=YearAdj, y=Temperature, fill=Drought))+
  geom_point(shape=21, color="black")+
  facet_wrap(~Season, scales="free")+
  scale_fill_viridis_d()+
  ylab("Temperature (°C)")+
  theme_bw()
```

Plot seasonal data by Drought index

```{r}
ggplot(data_seasonal, aes(x=Drought, y=Temperature, fill=Drought))+
  geom_boxplot()+
  facet_wrap(~Season, scales="free")+
  scale_fill_viridis_d()+
  ylab("Temperature (°C)")+
  theme_bw()
```

# Analyses

## Regional

### Drought

```{r}
m_reg_d<-aov(Temperature ~ Drought + Region, data=data_regional)
```

Check assumptions:

```{r}
model_plotter(m_reg_d, data_regional)
```

Check results

```{r}
Anova(m_reg_d, type=2)
```

post-hoc test

```{r, fig.width=12, fig.height=12}
tukey_plotter(m_reg_d, "Region", "Drought")
```

### Year

```{r}
m_reg_y<-aov(Temperature ~ Year_fac + Region, data=data_regional)
```

Check assumptions:

```{r}
model_plotter(m_reg_y, data_regional)
```

Check results

```{r}
Anova(m_reg_y, type=2)
```

post-hoc test

```{r, fig.width=12, fig.height=12}
tukey_plotter(m_reg_y, "Region", "Year_fac")
```

## Seasonal

### Drought

```{r}
m_seas_d<-aov(Temperature ~ Drought + Season, data=data_seasonal)
```

Check assumptions:

```{r}
model_plotter(m_seas_d, data_seasonal)
```

Check results

```{r}
Anova(m_seas_d, type=2)
```

post-hoc test

```{r, fig.width=12, fig.height=12}
tukey_plotter(m_seas_d, "Season", "Drought")
```

### Year

```{r}
m_seas_y<-aov(Temperature ~ Year_fac + Season, data=data_seasonal)
```

Check assumptions:

```{r}
model_plotter(m_seas_y, data_seasonal)
```

Check results

```{r}
Anova(m_seas_y, type=2)
```

post-hoc test

```{r, fig.width=12, fig.height=12}
tukey_plotter(m_seas_y, "Season", "Year_fac")
```

# Comparing 2021 to prior years

```{r}
raw_data<-DroughtData::raw_wq_1975_2021%>%
  filter(!is.na(Temperature))%>%
  left_join(data_regional%>%
              distinct(YearAdj, SVIndex, YearType, Drought),
            by="YearAdj")%>%
  mutate(across(c(Drought, YearType), list(`21`=~if_else(YearAdj==2021, "2021", as.character(.x)))),
         across(c(YearType, YearType_21), ~factor(.x, levels=c("2021", "Critical", "Dry", "Below Normal", "Above Normal", "Wet"))),
         Region=factor(Region, levels=c("Suisun Marsh", "Suisun Bay", "Confluence", "SouthCentral", "North")),
         Season=factor(Season, levels=c("Winter", "Spring", "Summer", "Fall")))
```

How does 2021 compare to Drought, Normal, and Wet periods?
```{r}
ggplot(raw_data, aes(x=Drought_21, y=Temperature, fill=Drought))+
  geom_boxplot()+
  scale_fill_viridis_d(direction = -1)+
  xlab("Drought")+
  ylab("Temperature (°C)")+
  theme_bw()
```

Does that change regionally or seasonally?
```{r, fig.width=12, fig.height=12}
ggplot(raw_data, aes(x=Drought_21, y=Temperature, fill=Drought))+
  geom_boxplot()+
  scale_fill_viridis_d(direction = -1)+
  facet_grid(Season~Region, scales = "free_y")+
  xlab("Drought")+
  ylab("Temperature (°C)")+
  theme_bw(base_size = 16)
```


How does 2021 compare to each water year type?
```{r}
ggplot(raw_data, aes(x=YearType_21, y=Temperature, fill=YearType))+
  geom_boxplot()+
  scale_fill_viridis_d(direction = -1)+
  xlab("Year type")+
  ylab("Temperature (°C)")+
  theme_bw()
```

Does that change regionally or seasonally?
```{r, fig.width=12, fig.height=12}
ggplot(raw_data, aes(x=YearType_21, y=Temperature, fill=YearType))+
  geom_boxplot()+
  scale_fill_viridis_d(direction = -1)+
  facet_grid(Season~Region, scales = "free_y")+
  xlab("Year type")+
  ylab("Temperature (°C)")+
  theme_bw(base_size = 16)+
  theme(axis.text.x=element_text(angle=45, hjust=1))
```
---
title: "Zooplankton salinity relationships in Suisun"
author: "Sam Bashevkin"
date: "3/15/2022"
output: html_document
editor_options: 
  chunk_output_type: console
knit: (function(input, ...) {
    rmarkdown::render(
      input,
      output_dir = 'docs',
      envir = globalenv()
    )
    })
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(scipen=999)
```

Load packages
```{r, message=FALSE}
require(dplyr)
require(zooper)
require(lubridate)
require(readr)
require(tidyr)
require(ggplot2)
require(sf)
require(readxl)
require(stringr)
require(mgcv)
require(purrr)
```

Load zoop data
```{r}
zoop_data<-Zoopsynther(Data_type="Community", Sources=c("EMP", "STN", "20mm", "FMWT"), Time_consistency = TRUE)
```


Read in zoop mass conversions
```{r}
zoop_mass_conversions<-read_excel("~/ZoopSynth/Data paper/Biomass conversions.xlsx", sheet="Micro and Meso-zooplankton")%>%
  mutate(Taxname=case_when(Taxname=="Sinocalanus"~"Sinocalanus doerrii",
                           TRUE ~ Taxname),
         Taxlifestage=paste(Taxname, Lifestage))%>%
  select(Taxlifestage, CarbonWeight_ug)
```

Read in zoop groupings
```{r}
zoop_groups<-read_csv("Data/zoopcrosswalk2.csv", col_types=cols_only(Taxlifestage="c", IBMR="c"))%>%
  distinct()
```


Load Mysid biomass data
```{r}
zoop_mysid<-read_excel("Data/1972-2020MysidBPUEMatrix.xlsx",
                       sheet="Mysid_BPUE_matrix_1972-2020", na = "NA",
                       col_types = c(rep("numeric", 4), "date", "text", "text", rep("text", 7), rep("numeric", 8)))%>%
  select(Date=SampleDate, Station=StationNZ, BPUE=`Hyperacanthomysis longirostris`)%>%
  mutate(Source="EMP")%>%
  bind_rows(read_csv("Data/FMWT STN 2007to2019 Mysid BPUE.csv", 
                     col_types=cols_only(Station="c", SampleDate="c", Project="c", `Hyperacanthomysis longirostris`="d"))%>%
              rename(Date=SampleDate, Source=Project, BPUE=`Hyperacanthomysis longirostris`)%>%
              mutate(Date=mdy(Date),
                     Station=recode(Station, MONT="Mont", HONK="Honk")))%>%
mutate(BPUE_mysid=BPUE*1000, # Convert to ug
       Taxlifestage="Hyperacanthomysis longirostris Adult",
       SampleID=paste(Source, Station, Date),
       SizeClass="Macro")%>%
  select(SampleID, Taxlifestage, SizeClass, BPUE_mysid)
```


Start processing the zoop data
```{r}
zoop_data_mass<-zoop_data%>%
  mutate(Taxlifestage=str_remove(Taxlifestage, fixed("_UnID")))%>%
  filter(
    !(SizeClass=="Meso" & #eliminating species which are counted in meso and micro and retained better in the micro net from the meso calcs
        
        Taxlifestage%in%c("Asplanchna Adult", "Copepoda Larva","Cyclopoida Juvenile", "Eurytemora Larva", "Harpacticoida Undifferentiated",
                          "Keratella Adult", "Limnoithona Adult", "Limnoithona Juvenile", "Limnoithona sinenesis Adult", "Limnoithona tetraspina
                                    Adult", "Oithona Adult", "Oithona Juvenile", "Oithona davisae Adult", "Polyarthra Adult","Pseudodiaptomus Larva", 
                          "Rotifera Adult", "Sinocalanus doerrii Larva", "Synchaeta Adult", "Synchaeta bicornis Adult", "Trichocerca Adult")) &
      
      !(SizeClass=="Micro" &Taxlifestage%in%c("Cirripedia Larva", "Cyclopoida Adult", "Oithona similis")) & #removing categories better retained in meso net from micro net matrix
      Order!="Amphipoda" &
      (Order!="Mysida" | Taxlifestage=="Hyperacanthomysis longirostris Adult"))%>%
  mutate(Taxlifestage=recode(Taxlifestage, `Synchaeta bicornis Adult`="Synchaeta Adult",
                             `Pseudodiaptomus Adult`="Pseudodiaptomus forbesi Adult",
                             `Acanthocyclops vernalis Adult`="Acanthocyclops Adult"))%>%
  left_join(zoop_mass_conversions, by="Taxlifestage")%>%
  left_join(zoop_mysid, by=c("SampleID", "Taxlifestage", "SizeClass"))%>%
  left_join(zoop_groups, by="Taxlifestage")%>%
  mutate(BPUE=if_else(Taxlifestage=="Hyperacanthomysis longirostris Adult", BPUE_mysid, CPUE*CarbonWeight_ug))%>%
  filter(!is.na(BPUE) & !is.na(Latitude) & !is.na(Longitude) & !is.na(SalSurf))%>% # Removes any data without BPUE, which is currently restricted to Decapod Larvae, and H. longirostris from STN. Also removes 20mm and EMP EZ stations without coordinates
  group_by(IBMR)%>%
  mutate(flag=if_else(all(c("Micro", "Meso")%in%SizeClass), "Remove", "Keep"))%>% # This and the next 2 lines are meant to ensure that all categories are consistent across the surveys. Since only EMP samples microzoops, only EMP data can be used for categories that include both micro and mesozoops.
  ungroup()%>%
  filter(!(flag=="Remove" & Source!="EMP"))%>%
  select(SampleID, Station, Latitude, Longitude, SalSurf, Date, Year, IBMR, BPUE)%>%
  group_by(across(-BPUE))%>%
  summarise(BPUE=sum(BPUE), .groups="drop")%>%
  st_as_sf(coords=c("Longitude", "Latitude"), crs=4326)%>%
  st_transform(crs=st_crs(deltamapr::R_EDSM_Subregions_Mahardja))%>%
  st_join(deltamapr::R_EDSM_Subregions_Mahardja%>%
            select(SubRegion))%>%
  st_drop_geometry()%>%
  filter(SubRegion=="Suisun Marsh")%>%
  mutate(doy=yday(Date),
         Year_fac=factor(Year),
         Station_fac=factor(Station),
         BPUE_log1p=log(BPUE+1))

write_csv(zoop_data_mass, "Outputs/zoop_data_mass.csv")
```

Set up models
```{r}
newdata<-expand_grid(date=mdy(paste(1:12, 15, 2001, sep="/")),
                     SalSurf=seq(min(round(zoop_data_mass$SalSurf), 1), 
                                 round(max(zoop_data_mass$SalSurf), 1), by=0.1))%>%
  mutate(Month=month(date),
         doy=yday(date),
         Year_fac="2010",
         Station_fac="NZ032")%>%
  select(Month, doy, Year_fac, Station_fac, SalSurf)
```


model
```{r}
sal_model<-function(group){
  par(mfrow=c(2,2))
  cat("<<<<<<<<<<<<<<<<<<<<<<< modeling", group, ">>>>>>>>>>>>>>>>>>>>>>>>>\n\n")
  
  model<-gam(BPUE_log1p ~ te(SalSurf, doy, k=c(5,5), bs=c("cs", "cc")) + 
               s(Year_fac, bs="re") + s(Station_fac, bs="re"),
             data=filter(zoop_data_mass, IBMR==group & Year>=2000), 
             method="REML")
  
  cat("-------------gam check-------------\n")
  gam.check(model)
  
  cat("\n\n-------------summary-------------\n")
  print(summary(model))
  
  sal<-predict(model, type="terms", terms="te(SalSurf,doy)", newdata=newdata, se.fit=T)%>%
    as_tibble()%>%
    mutate(across(everything(), as.vector))%>%
    rename(fit=starts_with("fit"), se=starts_with("se.fit"))%>%
    bind_cols(newdata%>%
                select(-Year_fac, -Station_fac), 
              .)
  
  out<-list(model=model, sal=sal)
  return(out)
}
```

Apply model to all groups
```{r}
sal_models<-map(set_names(unique(zoop_data_mass$IBMR)), sal_model)
```

Extract salinity conversions
```{r}
sal_conversions<-map_dfr(sal_models, ~.x[["sal"]], .id = "IBMR")

str(sal_conversions)
```

plot salinity conversions
```{r}
ggplot(sal_conversions, aes(x=SalSurf, y=fit, ymin=fit-se, ymax=fit+se, fill=IBMR))+
  geom_ribbon(alpha=0.4)+
  facet_wrap(~Month)+
  scale_fill_viridis_d()+
  theme_bw()
```

Load in SMSCG modeled salinity
```{r}
SMSCG_sal<-read_csv("Data/SMSCG salinity modeling/bdl_summer_fall_2022_psu_filtered.csv", skip = 10)%>%
  mutate(Month=month(datetime))%>%
  drop_na()%>%
  group_by(Month)%>%
  summarise(across(contains("_bn_"), ~round(mean(.x), 1)))
```

Plot SMSCG modeld salinity
```{r}
ggplot(pivot_longer(SMSCG_sal, cols=contains("_bn_"), names_to="Scenario", values_to="Salinity"), aes(x=Month, y=Salinity, color=Scenario))+
  geom_line()+
  scale_color_viridis_d()+
  scale_x_continuous(breaks=1:12)+
  theme_bw()
```


salinity conversion function
```{r}
sal_fix<-function(data, sal_conversions, sal_target, target_column, months){
  
  salinity_conversions<-sal_conversions%>%
    filter(Month%in%months)%>% ## November is not included in the salinity target
    mutate(SalSurf=as.character(SalSurf))%>%
    select(IBMR, Month, SalSurf, fit)
  
  target_outside<-setdiff(as.character(sal_target[[target_column]]), salinity_conversions$SalSurf)
  
  if(length(target_outside)>0){
    cat("Some target salinities are out of range for the prediction. They are:", sort(target_outside))
  }
  
  sal_conversions_target<-salinity_conversions%>%
    semi_join(sal_target%>%
                mutate(SalSurf=as.character(.data[[target_column]])), 
              by=c("Month", "SalSurf"))%>%
    select(IBMR, Month, fit_target=fit)
    
  if(any(duplicated(paste(sal_conversions_target$Month, sal_conversions_target$IBMR)))){
    stop("sal_conversions were duplicated in filtering out the target salinities")
  }
  
  #Make sure all months are present for each IBMR
  monthcheck<-sal_conversions_target%>%
    group_by(IBMR)%>%
    summarise(N=n_distinct(Month))
  
  if(any(monthcheck$N!=length(months))){
    stop("Some months are missing in the sal_target")
  }
  
  salinity_conversions_correction<-salinity_conversions%>%
    left_join(sal_conversions_target, by=c("IBMR", "Month"))%>%
    mutate(Correction=fit_target-fit)%>%
    select(IBMR, Month, SalSurf, Correction)
  
  sals<-unique(salinity_conversions_correction$SalSurf)
  
  data<-data%>%
    mutate(Sal_merge=as.character(round(SalSurf, 1)))
  
  outrange<-setdiff(data$Sal_merge, sals)
  
  if(length(outrange)>0){
    cat("Some salinities are out of range for the prediction. They are:", sort(outrange))
  }
  
  data<-data%>%
    left_join(salinity_conversions_correction, by=c("Month", "Sal_merge"="SalSurf", "IBMR"))%>%
    mutate(BPUE_adj=BPUE+Correction)
  
  return(data)
}
```

Prepare data for conversion
```{r}
# From Rosie:
#Calculate water year function
wtr_yr <- function(dates, start_month=12) {
  # Convert dates into POSIXlt
  dates.posix = as.POSIXlt(dates)
  # Year offset
  offset = ifelse(dates.posix$mon == start_month - 1, 1, 0)
  # Water year
  adj.year = dates.posix$year + 1900 + offset
  # Return the water year
  adj.year
}

year_types<-read_csv(url("https://raw.githubusercontent.com/rosehartman/DCGmodeling/main/yeartypes.csv"))%>%
  rename(Yearadj = Year)

months<-c(6,7,8,9,10)

zoop_data_mass_bn<-zoop_data_mass%>%
  mutate(Yearadj = wtr_yr(Date),
         Month=month(Date)) %>%
  filter(Year > 2000)%>%
  left_join(year_types) %>%
  filter(Yr_type == "Below Normal" & Month %in% months)%>%
  select(Date, Month, Year, SalSurf, IBMR, BPUE)
```


Apply the conversion function
```{r}
zoop_corrected<-map(set_names(c("bdl_bn_noact", "bdl_bn_smscg4", "bdl_bn_smscg6")), ~sal_fix(zoop_data_mass_bn, sal_conversions, SMSCG_sal, .x, months))%>%
  bind_rows(.id="Scenario")
```

### We're getting negative BPUEs and some NA BPUEs in the adjusted values

Plot the result
```{r}
ggplot(zoop_corrected, aes(x=Date, y=BPUE_adj, color=Scenario))+
  geom_point()+
  scale_y_continuous(trans="log1p", breaks = c(0, 10^(1:6)))+
  facet_wrap(~IBMR, scales="free")+
  theme_bw()
```

Plot BPUE vs BPUE_adj
```{r}
ggplot(zoop_corrected, aes(x=BPUE, y=BPUE_adj, color=Scenario))+
  geom_point()+
  scale_y_continuous(trans="log1p", breaks = c(0, 10^(1:6)))+
  scale_x_continuous(trans="log1p", breaks = c(0, 10^(1:6)))+
  facet_wrap(~IBMR, scales="free")+
  theme_bw()
```

Plot BPUE vs correction
```{r}
ggplot(zoop_corrected, aes(x=BPUE, y=Correction, color=Scenario))+
  geom_point()+
  geom_hline(yintercept=0)+
  xlab("BPUE (on log(x+1) scale)")+
  scale_x_continuous(trans="log1p", breaks = c(0, 10^(1:6)))+
  facet_wrap(~IBMR, scales="free")+
  theme_bw()
```

Summarise zoops by IBMR, scenario, and month
```{r}
zoop_bn_sum<-zoop_corrected%>%
  group_by(IBMR, Month, Scenario)%>%
  summarise(BPUE_sum=sum(BPUE_adj), .groups="drop")
```

Plot summarized CPUE
```{r}
ggplot(zoop_bn_sum, aes(x=Month, y=BPUE_sum, color=Scenario))+
  geom_point(alpha=0.4)+
  facet_wrap(~IBMR, scales="free")+
  theme_bw()
```

